---
format: hypermake.v0

name: zpi1
description: Robot zpi1

targets:
  deps-zpi1-go:
    description: restore Go vendor
    watches:
      - brain/vendor/manifest
    workdir: brain
    cmds:
      - gvt restore

  deps-zpi1-node:
    description: install npm packages
    watches:
      - robot/package.json
    workdir: robot
    cmds:
      - npm install

  deps-zpi1:
    after: ['dep-zpi1-*']

  gen-zpi1-go:
    description: generate Go code
    watches:
      - proto
    cmds:
      - tbus-proto-gen -lang=go -out=brain -from=proto zupi

  gen-zpi1-node:
    description: generate Node.js code
    watches:
      - proto
    cmds:
      - mkdir -p robot/gen
      - tbus-proto-gen -lang=js -out=robot/gen -from=proto zupi

  gen-zpi1:
    after: ['gen-zpi1-*']

  build-zpi1-brain:
    description: build zpi1 brain
    after:
      - gen-zpi1-go
      - deps-zpi1-go
    watches:
      - 'brain/**/**/*.go'
    workdir: brain
    cmds:
      - $HMAKE_PROJECT_DIR/hack/build-go.sh zpi1-brain ./zpi1-brain

  build-zpi1-vision:
    description: build zpi1 vision analyzer
    watches:
      - vision/inc
      - vision/src
      - vision/CMakeLists.txt
      - vision/cmake
    image: dockcross/linux-x64:latest
    workdir: vision
    cmds:
      - mkdir -p _build
      - cd _build && cmake .. && make

  build-zpi1:
    after: ['build-zpi1-*']
